<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ArmEn Project Bibliography</title>

<style>
  body { font-family: sans-serif; padding: 20px; }
  h1 { margin-bottom: 15px; }
  h2 { margin-top: 30px; }
  input { padding: 6px; margin: 5px; width: 260px; }
  li { margin-bottom: 10px; }

  #tabs button { padding: 8px 16px; margin-right: 5px; cursor: pointer; }
  #tabs button.active { background:#007bff; color:white; border:none; }

  .author { margin-bottom: 20px; }
  .work { margin-left: 20px; color: blue; cursor: pointer; text-decoration: underline; }
  .work:hover { color: darkblue; }

  #citationBox {
    margin-top: 20px;
    padding: 12px;
    border: 1px solid #ccc;
    background: #f9f9f9;
  }

  .field-label { font-weight: bold; }
</style>
</head>

<body>

<h1>ArmEn Project Bibliography</h1>

<div id="tabs">
  <button id="searchTab" class="active">Search</button>
  <button id="authorsTab">Authors</button>
</div>

<div id="searchPage">
  <input id="universalSearch" placeholder="Search anything">
  <ul id="results"></ul>
</div>

<div id="authorsPage" style="display:none;">
  <div id="authorsList"></div>
  <h2>Citation Info</h2>
  <div id="citationBox">Click a title to see details.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
let entries = [];

/* ---------- load CSV ---------- */
Papa.parse('demo.csv', {
  header: true,
  download: true,
  skipEmptyLines: true,
  complete: function(results) {
    entries = results.data;
    displaySearch(entries);
    buildAuthors(entries);
  }
});

/* ---------- search ---------- */
universalSearch.oninput = e => {
  const q = e.target.value.toLowerCase();
  displaySearch(entries.filter(row =>
    Object.values(row).join(' ').toLowerCase().includes(q)
  ));
};

function displaySearch(list) {
  results.innerHTML = '';
  list.forEach(row => {
    const li = document.createElement('li');
    li.textContent =
      (row.Title || '[No title]') +
      ' â€” ' +
      (row.Author || row.Editor || 'Unknown');
    results.appendChild(li);
  });
}

/* ---------- authors ---------- */
function buildAuthors(data) {
  const map = {};
  data.forEach(row => {
    (row.Author || '').split(/\s*;\s*/).forEach(a => {
      if (!a) return;
      map[a] ??= [];
      map[a].push(row);
    });
  });

  authorsList.innerHTML = '';
  Object.keys(map).sort().forEach(author => {
    const div = document.createElement('div');
    div.className = 'author';
    div.innerHTML = `<strong>${author}</strong>`;
    map[author].forEach(row => {
      const w = document.createElement('div');
      w.className = 'work';
      w.textContent = row.Title || '[No title]';
      w.onclick = () => showCitation(row);
      div.appendChild(w);
    });
    authorsList.appendChild(div);
  });
}

/* ---------- citation (dynamic fields) ---------- */
function showCitation(row) {
  citationBox.innerHTML = '';

  Object.entries(row).forEach(([key, rawValue]) => {
    const value = (rawValue || '').trim();
    if (!value) return;

    const p = document.createElement('p');
    p.innerHTML = `<span class="field-label">${key}:</span> ${formatValue(key, value)}`;
    citationBox.appendChild(p);
  });
}

/* ---------- formatting ---------- */
function formatValue(key, value) {
  const lower = key.toLowerCase();

  if (lower.includes('url') || lower.includes('doi') || lower.includes('link')) {
    return `<a href="${value}" target="_blank">${value}</a>`;
  }

  return value;
}

/* ---------- tabs ---------- */
searchTab.onclick = () => {
  searchPage.style.display='block';
  authorsPage.style.display='none';
  searchTab.classList.add('active');
  authorsTab.classList.remove('active');
};
authorsTab.onclick = () => {
  searchPage.style.display='none';
  authorsPage.style.display='block';
  authorsTab.classList.add('active');
  searchTab.classList.remove('active');
};
</script>

</body>
</html>
