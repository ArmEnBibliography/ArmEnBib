<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bibliography Search & Authors – ArmEn Project</title>

<style>
body { 
  font-family: sans-serif; 
  padding: 20px; 
  background-image: url("./ArmEn.png");
  background-position: top;
  background-repeat: no-repeat;
  margin-top: 350px;
}
h1 { margin-bottom: 15px; }
h2 { margin-top: 30px; }
input { padding: 6px; margin: 5px; width: 260px; }
li { margin-bottom: 25px; }

.autocomplete { position: relative; display: inline-block; }
.suggestions {
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  max-height: 150px;
  overflow-y: auto;
  width: 260px;
  z-index: 1000;
}
.suggestions div { padding: 6px; cursor: pointer; }
.suggestions div:hover { background: #eee; }

.author { margin-bottom: 20px; }
.work { margin-left: 20px; cursor: pointer; color: blue; text-decoration: underline; }
.work:hover { color: darkblue; }

.citation-inline {
  margin-left: 40px;
  margin-top: 5px;
  padding: 5px;
  border-left: 2px solid #ccc;
  background: #f9f9f9;
}

#tabs { margin-bottom: 20px; }
#tabs button { padding: 10px 20px; margin-right: 5px; cursor: pointer; }
#tabs button.active { background-color: #007bff; color: white; border: none; }

.suggested-citation {
  margin-top: 8px;
  margin-bottom: 10px;
  color: #333;
}
</style>
</head>

<body>

<h1>ArmEn Project Bibliography</h1>

<div id="tabs">
  <button id="searchTab" class="active">Search</button>
  <button id="authorsTab">Authors</button>
</div>

<div id="searchPage">
<ul id="results"></ul>
</div>

<div id="authorsPage" style="display:none;">
  <div id="authorsList"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
let bibEntries = [];

// ---------- CHICAGO ----------
function makeChicagoCitation(entry) {
  const r = entry._raw;
  let parts = [];
  if (r.Author) parts.push(r.Author);
  if (r.Title) parts.push(`<em>${r.Title}</em>`);
  if (r.Translator) parts.push(`trans. ${r.Translator}`);
  if (r.Editor) parts.push(`ed. ${r.Editor}`);
  if (r['Publication Title']) parts.push(r['Publication Title']);
  if (r.Place && r.Publisher && r['Publication Year'])
    parts.push(`(${r.Place}: ${r.Publisher}, ${r['Publication Year']})`);
  else if (r.Publisher && r['Publication Year']) parts.push(`(${r.Publisher}, ${r['Publication Year']})`);
  else if (r['Publication Year']) parts.push(`(${r['Publication Year']})`);
  return parts.join(', ');
}

// ---------- APA (Primary-aware) ----------
function makeApaCitation(entry) {
  const r = entry._raw;

  // Detect primary source by Manual Tags
  const manualTags = r['Manual Tags'] || '';
  const isPrimary = manualTags
    .split(/\s*;\s*/)
    .some(t => t.toLowerCase().startsWith('primary'));

  let parts = [];

  if (isPrimary) {
    // Primary source: use Translator or Editor as main responsible
    if (r.Translator) {
      parts.push(`${r.Translator} (Trans.).`);
    } else if (r.Editor) {
      parts.push(`${r.Editor} (Ed.).`);
    }

    if (r['Publication Year']) parts.push(`(${r['Publication Year']}).`);
    if (r.Title) parts.push(`<em>${r.Title}</em>.`);
    if (r.Publisher) parts.push(`${r.Publisher}.`);
    if (r.Author) parts.push(`(Original work by ${r.Author})`);

  } else {
    // Secondary source or article: Author is main
    if (r.Author) {
      parts.push(`${r.Author}.`);
    } else if (r.Editor) {
      parts.push(`${r.Editor} (Ed.).`);
    }

    if (r['Publication Year']) parts.push(`(${r['Publication Year']}).`);
    if (r.Title) parts.push(`<em>${r.Title}</em>.`);
    if (r['Publication Title']) parts.push(`${r['Publication Title']},`);
    if (r.Pages) parts.push(`${r.Pages}.`);
    if (r.Publisher) parts.push(`${r.Publisher}.`);
  }

  return parts.join(' ');
}

// ---------- LOAD CSV ----------
Papa.parse('demo.csv', {
  header: true,
  download: true,
  skipEmptyLines: true,
  complete: function(results) {
    bibEntries = results.data.map(e => {
      const entry = { _raw: e };

      // Suggested citations for both styles
      entry._raw.SuggestedCitation =
        `<strong>Suggested Citation – Chicago:</strong> ${makeChicagoCitation(entry)}<br>` +
        `<strong>Suggested Citation – APA:</strong> ${makeApaCitation(entry)}`;

      return entry;
    });
    displaySearchResults(bibEntries);
    buildAuthorList();
  }
});

// ---------- DISPLAY SEARCH RESULTS ----------
function displaySearchResults(entries) {
  const results = document.getElementById('results');
  results.innerHTML = '';
  entries.forEach(e => {
    const li = document.createElement('li');
    li.innerHTML = `<div class="suggested-citation">${e._raw.SuggestedCitation}</div>`;
    results.appendChild(li);
  });
}

// ---------- AUTHORS ----------
function buildAuthorList() {
  const map = {};
  bibEntries.forEach(e => {
    const a = e._raw.Author;
    if (!a) return;
    if (!map[a]) map[a] = [];
    map[a].push(e);
  });

  const container = document.getElementById('authorsList');
  container.innerHTML = '';

  Object.keys(map).sort().forEach(author => {
    const d = document.createElement('div');
    d.className = 'author';
    d.innerHTML = `<strong>${author}</strong>`;

    map[author].forEach(e => {
      const w = document.createElement('div');
      w.className = 'work';
      w.textContent = e._raw.Title || '';

      const c = document.createElement('div');
      c.className = 'citation-inline';
      c.style.display = 'none';
      c.innerHTML = `<div class="suggested-citation">${e._raw.SuggestedCitation}</div>`;

      w.onclick = () => {
        c.style.display = c.style.display === 'none' ? 'block' : 'none';
      };

      d.appendChild(w);
      d.appendChild(c);
    });

    container.appendChild(d);
  });
}

// ---------- TABS ----------
const searchTab = document.getElementById('searchTab');
const authorsTab = document.getElementById('authorsTab');
const searchPage = document.getElementById('searchPage');
const authorsPage = document.getElementById('authorsPage');

searchTab.onclick = () => {
  searchPage.style.display = 'block';
  authorsPage.style.display = 'none';
  searchTab.classList.add('active');
  authorsTab.classList.remove('active');
};

authorsTab.onclick = () => {
  searchPage.style.display = 'none';
  authorsPage.style.display = 'block';
  authorsTab.classList.add('active');
  searchTab.classList.remove('active');
};
</script>

</body>
</html>
