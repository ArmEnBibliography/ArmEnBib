<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ArmEn Bibliography</title>

<style>
  body { font-family: sans-serif; padding: 20px; }
  h1 { margin-bottom: 15px; }
  h2 { margin-top: 30px; }

  input { padding: 6px; margin: 6px 0; width: 300px; }

  #tabs button {
    padding: 8px 16px;
    margin-right: 5px;
    cursor: pointer;
  }
  #tabs button.active {
    background: #007bff;
    color: white;
    border: none;
  }

  ul { list-style: none; padding-left: 0; }
  li { margin-bottom: 8px; }

  .author { margin-bottom: 20px; }
  .work {
    margin-left: 20px;
    color: blue;
    cursor: pointer;
    text-decoration: underline;
  }

  #citationBox {
    margin-top: 15px;
    padding: 12px;
    border: 1px solid #ccc;
    background: #f9f9f9;
  }

  .field-label {
    font-weight: bold;
  }
</style>
</head>

<body>

<h1>ArmEn Project Bibliography</h1>

<div id="tabs">
  <button id="searchTab" class="active">Search</button>
  <button id="authorsTab">Authors</button>
</div>

<!-- SEARCH PAGE -->
<div id="searchPage">
  <input id="searchBox" placeholder="Search anything">
  <ul id="results"></ul>
</div>

<!-- AUTHORS PAGE -->
<div id="authorsPage" style="display:none;">
  <div id="authorsList"></div>
  <h2>Citation Info</h2>
  <div id="citationBox">Click a title to see details.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
let entries = [];

/* ---------- LOAD CSV ---------- */
Papa.parse('demo.csv', {
  header: true,
  download: true,
  skipEmptyLines: true,
  complete: function(res) {
    entries = res.data;
    showSearch(entries);
    buildAuthors(entries);
  }
});

/* ---------- SEARCH ---------- */
searchBox.oninput = e => {
  const q = e.target.value.toLowerCase();
  showSearch(entries.filter(row =>
    Object.values(row).join(' ').toLowerCase().includes(q)
  ));
};

function showSearch(list) {
  results.innerHTML = '';
  list.forEach(row => {
    const li = document.createElement('li');
    li.textContent =
      (row.Title || '[No title]') +
      ' â€” ' +
      (row.Author || row.Editor || 'Unknown');
    results.appendChild(li);
  });
}

/* ---------- AUTHORS LIST ---------- */
function buildAuthors(data) {
  const authors = {};

  data.forEach(row => {
    const raw = row.Author || '';
    raw.split(/\s*;\s*/).forEach(name => {
      if (!name) return;
      authors[name] ??= [];
      authors[name].push(row);
    });
  });

  authorsList.innerHTML = '';

  Object.keys(authors).sort().forEach(author => {
    const div = document.createElement('div');
    div.className = 'author';
    div.innerHTML = `<strong>${author}</strong>`;

    authors[author].forEach(row => {
      const w = document.createElement('div');
      w.className = 'work';
      w.textContent = row.Title || '[No title]';
      w.onclick = () => showCitation(row);
      div.appendChild(w);
    });

    authorsList.appendChild(div);
  });
}

/* ---------- CITATION (ALL FIELDS, URL INCLUDED) ---------- */
function showCitation(row) {
  citationBox.innerHTML = '';

  Object.keys(row).forEach(key => {
    const raw = row[key];

    if (raw === null || raw === undefined) return;

    const value = raw.toString().replace(/\s+/g,' ').trim();
    if (value === '') return;

    const p = document.createElement('p');
    p.innerHTML = `<span class="field-label">${key}:</span> ${renderValue(key, value)}`;
    citationBox.appendChild(p);
  });
}

/* ---------- FIELD RENDERING ---------- */
function renderValue(key, value) {
  const k = key.toLowerCase();

  if (k === 'url' || k.includes('doi') || k.includes('link')) {
    return value
      .split(/\s*;\s*/)
      .map(v => `<a href="${v}" target="_blank">${v}</a>`)
      .join('<br>');
  }

  return value;
}

/* ---------- TABS ---------- */
searchTab.onclick = () => {
  searchPage.style.display = 'block';
  authorsPage.style.display = 'none';
  searchTab.classList.add('active');
  authorsTab.classList.remove('active');
};

authorsTab.onclick = () => {
  searchPage.style.display = 'none';
  authorsPage.style.display = 'block';
  authorsTab.classList.add('active');
  searchTab.classList.remove('active');
};
</script>

</body>
</html>
